@prefix ex:  <http://example.org/ifc43Shapes#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

ex:PropertySet a sh:SPARQLTarget;
    sh:select """
        SELECT ?this
        WHERE {
            ?this <http://schema.omg.org/spec/XMI/2.1/type> "uml:Class" .
            ?this <http://example.org/name> ?psetName . 

            {
                ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_TYPEDRIVENOVERRIDE> .
                ?stereo <http://example.org/base_Class> ?this .
            } UNION {
                ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_PERFORMANCEDRIVEN> .
                ?stereo <http://example.org/base_Class> ?this .
            } UNION {
                ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_OCCURRENCEDRIVEN> .
                ?stereo <http://example.org/base_Class> ?this .
            }
        }
   """
   .

ex:PropertySetProperty a sh:SPARQLTarget;
    sh:select """
        SELECT ?this
        WHERE {
            ?pset <http://schema.omg.org/spec/XMI/2.1/type> "uml:Class" .
            ?pset <http://example.org/name> ?psetName . 
            
            ?this <http://schema.omg.org/spec/XMI/2.1/type> "uml:Property" .
            ?this <http://example.org/containedIn> ?pset .

            {
                ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_TYPEDRIVENOVERRIDE> .
                ?stereo <http://example.org/base_Class> ?pset .
            } UNION {
                ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_PERFORMANCEDRIVEN> .
                ?stereo <http://example.org/base_Class> ?pset .
            } UNION {
                ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_OCCURRENCEDRIVEN> .
                ?stereo <http://example.org/base_Class> ?pset .
            }
        }
   """
   .

ex:hasApplicableClass a sh:SPARQLConstraint ;
    sh:message "The Property Set '{?psetName}' should have at least one applicability" ;
    sh:select """
        SELECT ?this ?psetName
        WHERE {
            ?this <http://example.org/name> ?psetName . 
            
            FILTER NOT EXISTS {
                ?assoc <http://schema.omg.org/spec/XMI/2.1/type> "uml:AssociationClass" .

                ?assoc <http://example.org/containedIn> ?package .
                ?package <http://example.org/name> "PropertySetsforObjects" .
                
                ?end1 a <http://example.org/memberEnd> .
                ?end1 <http://example.org/containedIn> ?assoc .
                ?end1 <http://schema.omg.org/spec/XMI/2.1/idref> ?prop1 .
                ?type1 <http://example.org/containedIn> ?prop1 .
                ?type1 <http://schema.omg.org/spec/XMI/2.1/idref> ?this .
                
                ?end2 a <http://example.org/memberEnd> .
                ?end2 <http://example.org/containedIn> ?assoc .
                ?end2 <http://schema.omg.org/spec/XMI/2.1/idref> ?prop2 .
                ?type2 <http://example.org/containedIn> ?prop2 .
                ?type2 <http://schema.omg.org/spec/XMI/2.1/idref> ?xid .
        
                FILTER(?end1 != ?end2) .
            }
        }
    """
    .

ex:hasPropertyType a sh:SPARQLConstraint ;
    sh:message "The Property '{?psetName}.{?propName}' has an incorrect type" ;
    sh:select """
        SELECT ?this ?propName ?psetName
        WHERE {
            ?this <http://example.org/name> ?propName . 
            ?this <http://example.org/containedIn> ?pset .
            ?pset <http://example.org/name> ?psetName .
            
            FILTER NOT EXISTS {
                ?type <http://example.org/containedIn> ?this .
                ?type a <http://example.org/type> .
                ?type <http://schema.omg.org/spec/XMI/2.1/idref> ?typeref .
                
                ?typeref a <http://example.org/packagedElement> .
                
                ?binding a <http://example.org/templateBinding> .
                ?binding <http://example.org/containedIn> ?typeref .
                ?binding <http://example.org/boundElement> ?proptype .
                
                ?proptype <http://example.org/containedIn> ?proppackage .
                ?proppackage <http://example.org/name> "propertytypes" .
                
                ?substitution <http://example.org/containedIn> ?binding .
                ?substitution <http://example.org/actual> ?actual .
                
                ?actual <http://example.org/name> ?actualname .
                
                FILTER(?actualname != "UNKNOWN") .
            }
        }
    """
    .

ex:hasDefinition a sh:SPARQLConstraint ;
    sh:message "The Property '{?psetName}.{?propName}' has no definition" ;
    sh:select """
        SELECT ?this ?propName ?psetName
        WHERE {
            ?this <http://example.org/name> ?propName . 
            ?this <http://example.org/containedIn> ?pset .
            ?pset <http://example.org/name> ?psetName .
            
            FILTER NOT EXISTS {
                ?doc a <http://example.org/MarkdownPropertyDefinition> .
                ?doc <http://example.org/hasHeading> ?propName .
            }
        }
    """
    .

ex:hasProperty a sh:SPARQLConstraint;
    sh:message "For document '{?filename}' a property cannot be found" ;
    sh:select """
        SELECT ?this ?filename
        WHERE {
            ?this a <http://example.org/MarkdownPropertyDefinition> .
            ?this <http://example.org/hasHeading> ?propName .
            ?this <http://example.org/hasFilename> ?filename .
            
            FILTER NOT EXISTS {
                # weird performance anomaly?
                # ?pset <http://schema.omg.org/spec/XMI/2.1/type> "uml:Class" .
                
                ?prop <http://schema.omg.org/spec/XMI/2.1/type> "uml:Property" .
                ?prop <http://example.org/containedIn> ?pset .
                ?prop <http://example.org/name> ?propName .
                
                {
                    ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_TYPEDRIVENOVERRIDE> .
                    ?stereo <http://example.org/base_Class> ?pset .
                } UNION {
                    ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_PERFORMANCEDRIVEN> .
                    ?stereo <http://example.org/base_Class> ?pset .
                } UNION {
                    ?stereo a <http://www.sparxsystems.com/profiles/thecustomprofile/1.0/PSET_OCCURRENCEDRIVEN> .
                    ?stereo <http://example.org/base_Class> ?pset .
                }
            }
        }
   """
   .

ex:Fail a sh:SPARQLConstraint ;
    sh:message "Generic failing constraint" ;
    sh:select """
        SELECT ?this
        WHERE {
            FILTER NOT EXISTS {
            ?this <http://example.org/doesNotExist> <http://example.org/something> .
            }
        }
    """
    .

ex:PsetApplicability a sh:NodeShape ;
    sh:target ex:PropertySet;
    sh:sparql ex:hasApplicableClass
    .

ex:PropertyType a sh:NodeShape ;
    sh:target ex:PropertySetProperty;
    sh:sparql ex:hasPropertyType
    .

ex:DefinitionForProperty a sh:NodeShape ;
    sh:target ex:PropertySetProperty;
    sh:sparql ex:hasDefinition
    .

ex:PropertyForDefinition a sh:NodeShape ;
    sh:targetClass <http://example.org/MarkdownPropertyDefinition>;
    sh:sparql ex:hasProperty
    .
